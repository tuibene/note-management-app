<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes App</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- React and ReactDOM -->
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.6/babel.min.js"></script>
    <!-- Axios for API calls -->
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
    <!-- Pusher and Laravel Echo for WebSocket -->
    <script src="https://cdn.jsdelivr.net/npm/pusher-js@8.4.0-rc2/dist/web/pusher.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/laravel-echo@1.15.3/dist/echo.min.js"></script>
    <!-- Service Worker for PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(err => console.error('Service Worker registration failed:', err));
            });
        }
    </script>
    <style>
        .dark-theme {
            background-color: #212529;
            color: #f8f9fa;
        }
        .dark-theme .navbar {
            background-color: #343a40 !important;
        }
        .dark-theme .card,
        .dark-theme .modal-content,
        .dark-theme .form-control,
        .dark-theme .list-group-item {
            background-color: #343a40;
            color: #f8f9fa;
            border-color: #495057;
        }
        .dark-theme .btn-outline-secondary {
            border-color: #6c757d;
            color: #6c757d;
        }
        .dark-theme .btn-outline-secondary:hover {
            background-color: #6c757d;
            color: #fff;
        }
        .note-card {
            transition: transform 0.3s;
            cursor: pointer;
            border-radius: 8px;
        }
        .note-card:hover {
            transform: translateY(-5px);
        }
        .note-icon {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
        }
        .image-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 8px;
        }
        .view-note-content {
            white-space: pre-wrap;
            margin-bottom: 1rem;
        }
        .view-note-image {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .shared-note-card {
            border-left: 4px solid #0d6efd;
        }
        .shared-note-meta {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .list-view .card {
            display: flex;
            flex-direction: row;
        }
        .list-view .card-body {
            flex: 1;
        }
        .list-view .card-header {
            flex: 0 0 auto;
        }
        .unverified-alert {
            background-color: #fff3cd;
            color: #664d03;
            border-color: #ffecb5;
        }
        .collaboration-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }
        .collaboration-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #0d6efd;
        }
        .spinner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        @media (max-width: 576px) {
            .list-view .card {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Cấu hình Axios
        axios.defaults.baseURL = 'http://localhost:8000/api';
        axios.defaults.headers.common['Authorization'] = `Bearer ${localStorage.getItem('token')}`;

        // Cấu hình Laravel Echo và Pusher
        window.Pusher = Pusher;
        window.Echo = new Echo({
            broadcaster: 'pusher',
            key: 'your-pusher-key', // Thay bằng PUSHER_APP_KEY từ .env
            cluster: 'mt1',
            forceTLS: true,
        });

        // IndexedDB setup
        const openDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('NotesDB', 1);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    db.createObjectStore('notes', { keyPath: 'id' });
                    db.createObjectStore('sharedNotes', { keyPath: 'id' });
                    db.createObjectStore('pendingSync', { keyPath: 'id' });
                    db.createObjectStore('labels', { keyPath: 'name' });
                };
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        };

        const saveToDB = async (storeName, data) => {
            const db = await openDB();
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            if (Array.isArray(data)) {
                data.forEach(item => store.put(item));
            } else {
                store.put(data);
            }
            return tx.complete;
        };

        const loadFromDB = async (storeName) => {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        };

        const syncPendingChanges = async () => {
            const pending = await loadFromDB('pendingSync');
            for (const change of pending) {
                try {
                    if (change.action === 'create') {
                        await axios.post('/notes', change.data);
                    } else if (change.action === 'update') {
                        await axios.put(`/notes/${change.id}`, change.data);
                    } else if (change.action === 'delete') {
                        await axios.delete(`/notes/${change.id}`);
                    } else if (change.action === 'create-label') {
                        await axios.post('/labels', change.data);
                    } else if (change.action === 'update-label') {
                        await axios.put(`/labels/${change.data.oldName}`, { name: change.data.newName });
                    } else if (change.action === 'delete-label') {
                        await axios.delete(`/labels/${change.data.name}`);
                    }
                    // Xóa thay đổi sau khi đồng bộ
                    const db = await openDB();
                    const tx = db.transaction('pendingSync', 'readwrite');
                    const store = tx.objectStore('pendingSync');
                    store.delete(change.id);
                    await tx.complete;
                } catch (err) {
                    console.error('Sync failed:', err);
                }
            }
        };

        // Login Screen Component
        function LoginScreen({ setIsLoggedIn, setUser }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [showRegister, setShowRegister] = useState(false);
            const [displayName, setDisplayName] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [error, setError] = useState('');
            const [showReset, setShowReset] = useState(false);
            const [resetEmail, setResetEmail] = useState('');
            const [otp, setOtp] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [confirmNewPassword, setConfirmNewPassword] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                if (!email || !password) {
                    setError('Please fill in all fields');
                    return;
                }
                try {
                    const response = await axios.post('/login', { email, password });
                    localStorage.setItem('token', response.data.token);
                    axios.defaults.headers.common['Authorization'] = `Bearer ${response.data.token}`;
                    setUser(response.data.user);
                    setIsLoggedIn(true);
                    setError('');
                } catch (err) {
                    setError(err.response?.data?.message || 'Login failed');
                }
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                if (!email || !displayName || !password || !confirmPassword) {
                    setError('Please fill in all fields');
                    return;
                }
                if (password !== confirmPassword) {
                    setError('Passwords do not match');
                    return;
                }
                try {
                    const response = await axios.post('/register', {
                        email,
                        display_name: displayName,
                        password,
                        password_confirmation: confirmPassword,
                    });
                    localStorage.setItem('token', response.data.token);
                    axios.defaults.headers.common['Authorization'] = `Bearer ${response.data.token}`;
                    setUser(response.data.user);
                    setIsLoggedIn(true);
                    setError('');
                } catch (err) {
                    setError(err.response?.data?.message || 'Registration failed');
                }
            };

            const handleResetRequest = async (e) => {
                e.preventDefault();
                if (!resetEmail) {
                    setError('Please enter your email');
                    return;
                }
                try {
                    await axios.post('/password/reset-request', { email: resetEmail });
                    setShowReset('otp');
                    setError('');
                } catch (err) {
                    setError(err.response?.data?.message || 'Error sending OTP');
                }
            };

            const handleResetOTP = async (e) => {
                e.preventDefault();
                if (!otp) {
                    setError('Please enter OTP');
                    return;
                }
                setShowReset('newPassword');
                setError('');
            };

            const handleResetPassword = async (e) => {
                e.preventDefault();
                if (!newPassword || !confirmNewPassword) {
                    setError('Please fill in all fields');
                    return;
                }
                if (newPassword !== confirmNewPassword) {
                    setError('Passwords do not match');
                    return;
                }
                try {
                    await axios.post('/password/reset', {
                        email: resetEmail,
                        token: otp,
                        password: newPassword,
                        password_confirmation: confirmNewPassword,
                    });
                    setShowReset(false);
                    setError('');
                    document.querySelector('#passwordResetModal .btn-close').click();
                } catch (err) {
                    setError(err.response?.data?.message || 'Error resetting password');
                }
            };

            return (
                <div className="container d-flex justify-content-center align-items-center min-vh-100">
                    <div className="card p-4 shadow-sm" style={{ maxWidth: '400px', width: '100%', borderRadius: '14px' }}>
                        <h3 className="text-center mb-4 fw-semibold">{showRegister ? 'Create Account' : 'Sign In'}</h3>
                        {error && <div className="alert alert-danger alert-dismissible fade show" role="alert">{error}<button type="button" className="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>}
                        {showRegister ? (
                            <form onSubmit={handleRegister} noValidate>
                                <div className="mb-3">
                                    <label htmlFor="email" className="form-label fw-medium">Email</label>
                                    <input
                                        type="email"
                                        className="form-control"
                                        id="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        required
                                        aria-describedby="emailFeedback"
                                    />
                                    <div id="emailFeedback" className="form-feedback">Email is required</div>
                                </div>
                                <div className="mb-3">
                                    <label htmlFor="displayName" className="form-label fw-medium">Display Name</label>
                                    <input
                                        type="text"
                                        className="form-control"
                                        id="displayName"
                                        value={displayName}
                                        onChange={(e) => setDisplayName(e.target.value)}
                                        required
                                        aria-describedby="displayNameFeedback"
                                    />
                                    <div id="displayNameFeedback" className="form-feedback">Display name is required</div>
                                </div>
                                <div className="mb-3">
                                    <label htmlFor="password" className="form-label fw-medium">Password</label>
                                    <input
                                        type="password"
                                        className="form-control"
                                        id="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        required
                                        aria-describedby="passwordFeedback"
                                    />
                                    <div id="passwordFeedback" className="form-feedback">Password is required</div>
                                </div>
                                <div className="mb-3">
                                    <label htmlFor="confirmPassword" className="form-label fw-medium">Confirm Password</label>
                                    <input
                                        type="password"
                                        className="form-control"
                                        id="confirmPassword"
                                        value={confirmPassword}
                                        onChange={(e) => setConfirmPassword(e.target.value)}
                                        required
                                        aria-describedby="confirmPasswordFeedback"
                                    />
                                    <div id="confirmPasswordFeedback" className="form-feedback">Please confirm your password</div>
                                </div>
                                <button type="submit" className="btn btn-primary w-100 fw-medium">Register</button>
                                <p className="text-center mt-3">
                                    Already have an account?{' '}
                                    <a href="#" className="text-primary" onClick={() => { setShowRegister(false); setError(''); }}>Sign In</a>
                                </p>
                            </form>
                        ) : (
                            <form onSubmit={handleLogin} noValidate>
                                <div className="mb-3">
                                    <label htmlFor="email" className="form-label fw-medium">Email</label>
                                    <input
                                        type="email"
                                        className="form-control"
                                        id="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        required
                                        aria-describedby="emailFeedback"
                                    />
                                    <div id="emailFeedback" className="form-feedback">Email is required</div>
                                </div>
                                <div className="mb-3">
                                    <label htmlFor="password" className="form-label fw-medium">Password</label>
                                    <input
                                        type="password"
                                        className="form-control"
                                        id="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        required
                                        aria-describedby="passwordFeedback"
                                    />
                                    <div id="passwordFeedback" className="form-feedback">Password is required</div>
                                </div>
                                <button type="submit" className="btn btn-primary w-100 fw-medium">Sign In</button>
                                <p className="text-center mt-3">
                                    No account?{' '}
                                    <a href="#" className="text-primary" onClick={() => { setShowRegister(true); setError(''); }}>Sign Up</a>
                                </p>
                                <p className="text-center">
                                    <a href="#" className="text-primary" data-bs-toggle="modal" data-bs-target="#passwordResetModal">Forgot Password?</a>
                                </p>
                            </form>
                        )}
                    </div>

                    {/* Password Reset Modal */}
                    <div className="modal fade" id="passwordResetModal" tabIndex="-1" aria-labelledby="passwordResetModalLabel" aria-hidden="true">
                        <div className="modal-dialog">
                            <div className="modal-content">
                                <div className="modal-header">
                                    <h5 className="modal-title fw-semibold" id="passwordResetModalLabel">Reset Password</h5>
                                    <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div className="modal-body">
                                    {error && <div className="alert alert-danger alert-dismissible fade show" role="alert">{error}<button type="button" className="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>}
                                    {!showReset ? (
                                        <form onSubmit={handleResetRequest}>
                                            <div className="mb-3">
                                                <label htmlFor="resetEmail" className="form-label fw-medium">Email</label>
                                                <input
                                                    type="email"
                                                    className="form-control"
                                                    id="resetEmail"
                                                    value={resetEmail}
                                                    onChange={(e) => setResetEmail(e.target.value)}
                                                    required
                                                    aria-describedby="resetEmailFeedback"
                                                />
                                                <div id="resetEmailFeedback" className="form-feedback">Email is required</div>
                                            </div>
                                            <button type="submit" className="btn btn-primary fw-medium">Send OTP</button>
                                        </form>
                                    ) : showReset === 'otp' ? (
                                        <form onSubmit={handleResetOTP}>
                                            <div className="mb-3">
                                                <label htmlFor="otp" className="form-label fw-medium">OTP</label>
                                                <input
                                                    type="text"
                                                    className="form-control"
                                                    id="otp"
                                                    value={otp}
                                                    onChange={(e) => setOtp(e.target.value)}
                                                    required
                                                    aria-describedby="otpFeedback"
                                                />
                                                <div id="otpFeedback" className="form-feedback">OTP is required</div>
                                            </div>
                                            <button type="submit" className="btn btn-primary fw-medium">Verify OTP</button>
                                        </form>
                                    ) : (
                                        <form onSubmit={handleResetPassword}>
                                            <div className="mb-3">
                                                <label htmlFor="newPassword" className="form-label fw-medium">New Password</label>
                                                <input
                                                    type="password"
                                                    className="form-control"
                                                    id="newPassword"
                                                    value={newPassword}
                                                    onChange={(e) => setNewPassword(e.target.value)}
                                                    required
                                                    aria-describedby="newPasswordFeedback"
                                                />
                                                <div id="newPasswordFeedback" className="form-feedback">New password is required</div>
                                            </div>
                                            <div className="mb-3">
                                                <label htmlFor="confirmNewPassword" className="form-label fw-medium">Confirm New Password</label>
                                                <input
                                                    type="password"
                                                    className="form-control"
                                                    id="confirmNewPassword"
                                                    value={confirmNewPassword}
                                                    onChange={(e) => setConfirmNewPassword(e.target.value)}
                                                    required
                                                    aria-describedby="confirmNewPasswordFeedback"
                                                />
                                                <div id="confirmNewPasswordFeedback" className="form-feedback">Please confirm your password</div>
                                            </div>
                                            <button type="submit" className="btn btn-primary fw-medium">Reset Password</button>
                                        </form>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Main App Component
        function App() {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [user, setUser] = useState({ email: '', displayName: '', avatar: '' });
            const [viewMode, setViewMode] = useState('grid');
            const [theme, setTheme] = useState('light');
            const [notes, setNotes] = useState([]);
            const [sharedNotes, setSharedNotes] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedLabels, setSelectedLabels] = useState([]);
            const [labels, setLabels] = useState(['Work', 'Personal']);
            const [userPreferences, setUserPreferences] = useState({
                fontSize: 'fs-5',
                noteColor: 'bg-white',
                theme: 'light'
            });
            const [isVerified, setIsVerified] = useState(false);
            const [selectedNote, setSelectedNote] = useState(null);
            const [noteForm, setNoteForm] = useState({ title: '', content: '', labels: [], pinned: false, isLocked: false, password: '', confirmPassword: '', images: [] });
            const [error, setError] = useState('');
            const [isOffline, setIsOffline] = useState(false);
            const [passwordInput, setPasswordInput] = useState('');
            const [collaborationUsers, setCollaborationUsers] = useState([]);
            const [isSaving, setIsSaving] = useState(false);

            // Kiểm tra trạng thái đăng nhập và đồng bộ khi online
            useEffect(() => {
                const token = localStorage.getItem('token');
                if (token) {
                    axios.get('/user')
                        .then(response => {
                            setUser(response.data);
                            setIsLoggedIn(true);
                            setIsVerified(response.data.email_verified_at !== null);
                        })
                        .catch(() => {
                            localStorage.removeItem('token');
                            setIsLoggedIn(false);
                        });
                }
                document.body.className = theme === 'light' ? '' : 'dark-theme';
                setIsOffline(!navigator.onLine);
                const handleOnline = () => {
                    setIsOffline(false);
                    syncPendingChanges();
                };
                const handleOffline = () => setIsOffline(true);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, [theme]);

            // Tải ghi chú từ backend và IndexedDB
            useEffect(() => {
                const loadData = async () => {
                    try {
                        if (!isOffline) {
                            const [notesResponse, sharedNotesResponse] = await Promise.all([
                                axios.get('/notes'),
                                axios.get('/shared-notes')
                            ]);
                            setNotes(notesResponse.data);
                            setSharedNotes(sharedNotesResponse.data);
                            await saveToDB('notes', notesResponse.data);
                            await saveToDB('sharedNotes', sharedNotesResponse.data);
                        } else {
                            const savedNotes = await loadFromDB('notes');
                            const savedSharedNotes = await loadFromDB('sharedNotes');
                            setNotes(savedNotes.length ? savedNotes : []);
                            setSharedNotes(savedSharedNotes.length ? savedSharedNotes : []);
                        }
                    } catch (err) {
                        console.error('Failed to load data:', err);
                        setError('Failed to load notes');
                    }
                };
                if (isLoggedIn) loadData();
            }, [isLoggedIn, isOffline]);

            // Tải nhãn từ backend và IndexedDB
            useEffect(() => {
                const loadLabels = async () => {
                    try {
                        if (!isOffline) {
                            const response = await axios.get('/labels');
                            setLabels(response.data.map(label => label.name));
                            await saveToDB('labels', response.data.map(label => label.name));
                        } else {
                            const savedLabels = await loadFromDB('labels');
                            setLabels(savedLabels.length ? savedLabels : ['Work', 'Personal']);
                        }
                    } catch (err) {
                        setError('Failed to load labels');
                    }
                };
                if (isLoggedIn) loadLabels();
            }, [isLoggedIn, isOffline]);

            // Lắng nghe WebSocket để cập nhật thời gian thực
            useEffect(() => {
                if (isLoggedIn && selectedNote) {
                    window.Echo.channel(`note.${selectedNote.id}`)
                        .listen('NoteUpdated', (e) => {
                            setNotes(prev => prev.map(note =>
                                note.id === e.note.id ? { ...note, ...e.note } : note
                            ));
                            setSharedNotes(prev => prev.map(note =>
                                note.id === e.note.id ? { ...note, ...e.note } : note
                            ));
                        });
                    return () => {
                        window.Echo.leave(`note.${selectedNote.id}`);
                    };
                }
            }, [selectedNote, isLoggedIn]);

            // Lưu ghi chú vào IndexedDB khi thay đổi
            useEffect(() => {
                if (notes.length) saveToDB('notes', notes);
                if (sharedNotes.length) saveToDB('sharedNotes', sharedNotes);
            }, [notes, sharedNotes]);

            // Tìm kiếm trực tiếp
            useEffect(() => {
                const delayDebounce = setTimeout(() => {
                    console.log('Searching for:', searchQuery);
                }, 300);
                return () => clearTimeout(delayDebounce);
            }, [searchQuery]);

            // Tự động lưu ghi chú
            useEffect(() => {
                if (!noteForm.title && !noteForm.content) return;
                const delayAutoSave = setTimeout(async () => {
                    setIsSaving(true);
                    if (!noteForm.title || !noteForm.content) {
                        setError('Title and content are required');
                        setIsSaving(false);
                        return;
                    }
                    if (noteForm.isLocked && (!noteForm.password || noteForm.password !== noteForm.confirmPassword)) {
                        setError('Passwords must match and cannot be empty');
                        setIsSaving(false);
                        return;
                    }
                    const newNote = {
                        id: selectedNote ? selectedNote.id : Date.now(),
                        title: noteForm.title,
                        content: noteForm.content,
                        created_at: selectedNote ? selectedNote.created_at : new Date().toISOString(),
                        pinned: noteForm.pinned,
                        pinned_at: noteForm.pinned ? (selectedNote?.pinned_at || new Date().toISOString()) : null,
                        labels: noteForm.labels,
                        is_locked: noteForm.isLocked,
                        password: noteForm.isLocked ? noteForm.password : null,
                        shared: selectedNote ? selectedNote.shared : false,
                        shared_with: selectedNote ? selectedNote.shared_with : [],
                        images: noteForm.images,
                        shared_by: selectedNote?.shared_by || null,
                        permission: selectedNote?.permission || null,
                        shared_at: selectedNote?.shared_at || null
                    };
                    try {
                        if (!isOffline) {
                            if (selectedNote) {
                                if (selectedNote.shared_by) {
                                    await axios.put(`/shared-notes/${selectedNote.id}`, newNote);
                                    setSharedNotes(prev => prev.map(note => note.id === selectedNote.id ? newNote : note));
                                } else {
                                    await axios.put(`/notes/${selectedNote.id}`, newNote);
                                    setNotes(prev => prev.map(note => note.id === selectedNote.id ? newNote : note));
                                }
                            } else {
                                const response = await axios.post('/notes', newNote);
                                setNotes(prev => [...prev, response.data]);
                            }
                        } else {
                            await saveToDB('pendingSync', { id: newNote.id, action: selectedNote ? 'update' : 'create', data: newNote });
                            if (selectedNote) {
                                if (selectedNote.shared_by) {
                                    setSharedNotes(prev => prev.map(note => note.id === selectedNote.id ? newNote : note));
                                } else {
                                    setNotes(prev => prev.map(note => note.id === selectedNote.id ? newNote : note));
                                }
                            } else {
                                setNotes(prev => [...prev, newNote]);
                            }
                        }
                        setError('');
                        document.querySelector('#noteModal .btn-close').click();
                    } catch (err) {
                        setError(err.response?.data?.message || 'Error saving note');
                    }
                    setIsSaving(false);
                }, 500);
                return () => clearTimeout(delayAutoSave);
            }, [noteForm, isOffline]);

            // Giả lập người dùng hợp tác
            useEffect(() => {
                if (selectedNote?.permission === 'edit' || selectedNote?.shared_with?.some(s => s.permission === 'edit')) {
                    const interval = setInterval(() => {
                        setCollaborationUsers(prev => {
                            const users = [
                                { name: 'User1', avatar: 'https://via.placeholder.com/24' },
                                { name: 'User2', avatar: 'https://via.placeholder.com/24' }
                            ];
                            return prev.length ? [] : [users[Math.floor(Math.random() * users.length)]];
                        });
                    }, 5000);
                    return () => clearInterval(interval);
                }
            }, [selectedNote]);

            // Xử lý chia sẻ ghi chú
            const handleShare = async (e) => {
                e.preventDefault();
                const emails = e.target.recipientEmails.value.split(',').map(email => email.trim());
                const permission = e.target.querySelector('select').value;
                if (!emails.length || !emails.every(email => email.includes('@'))) {
                    setError('Please enter valid email addresses');
                    return;
                }
                try {
                    const response = await axios.post(`/notes/${selectedNote.id}/share`, { emails, permission });
                    setNotes(prev => prev.map(note =>
                        note.id === selectedNote.id
                            ? { ...note, shared: true, shared_with: response.data.shared_with }
                            : note
                    ));
                    setError('');
                    document.querySelector('#shareNoteModal .btn-close').click();
                } catch (err) {
                    setError(err.response?.data?.message || 'Error sharing note');
                }
            };

            // Xử lý xác minh mật khẩu ghi chú
            const handlePasswordVerification = async (e) => {
                e.preventDefault();
                try {
                    const response = await axios.post(`/notes/${selectedNote.id}/verify-password`, { password: passwordInput });
                    if (response.data.verified) {
                        setError('');
                        document.querySelector('#passwordVerificationModal .btn-close').click();
                        const targetModal = e.target.closest('.modal').getAttribute('data-bs-target') || '#viewNoteModal';
                        if (targetModal === '#noteModal') {
                            setNoteForm({
                                title: selectedNote.title,
                                content: selectedNote.content,
                                labels: selectedNote.labels,
                                pinned: selectedNote.pinned,
                                isLocked: selectedNote.isLocked,
                                password: '',
                                confirmPassword: '',
                                images: selectedNote.images
                            });
                        } else if (targetModal === '#confirmDeleteModal') {
                            await axios.delete(`/notes/${selectedNote.id}`);
                            setNotes(prev => prev.filter(note => note.id !== selectedNote.id));
                        }
                        document.querySelector(targetModal).classList.add('show');
                        document.querySelector(targetModal).style.display = 'block';
                    } else {
                        setError('Incorrect password');
                    }
                } catch (err) {
                    setError(err.response?.data?.message || 'Error verifying password');
                }
                setPasswordInput('');
            };

            // Xử lý thay đổi mật khẩu ghi chú
            const handleNotePasswordChange = async (e) => {
                e.preventDefault();
                const currentPassword = e.target.currentPassword.value;
                const newPassword = e.target.newPassword.value;
                const confirmNewPassword = e.target.confirmNewPassword.value;
                try {
                    const response = await axios.post(`/notes/${selectedNote.id}/verify-password`, { password: currentPassword });
                    if (!response.data.verified) {
                        setError('Current password is incorrect');
                        return;
                    }
                    if (!newPassword || newPassword !== confirmNewPassword) {
                        setError('New passwords must match and cannot be empty');
                        return;
                    }
                    await axios.put(`/notes/${selectedNote.id}/password`, { password: newPassword });
                    setNotes(prev => prev.map(note =>
                        note.id === selectedNote.id
                            ? { ...note, password: newPassword, is_locked: true }
                            : note
                    ));
                    setError('');
                    document.querySelector('#notePasswordModal .btn-close').click();
                } catch (err) {
                    setError(err.response?.data?.message || 'Error changing password');
                }
            };

            // Xử lý tắt mật khẩu ghi chú
            const handleNotePasswordDisable = async (e) => {
                e.preventDefault();
                const currentPassword = e.target.currentPassword.value;
                try {
                    const response = await axios.post(`/notes/${selectedNote.id}/verify-password`, { password: currentPassword });
                    if (!response.data.verified) {
                        setError('Current password is incorrect');
                        return;
                    }
                    await axios.delete(`/notes/${selectedNote.id}/password`);
                    setNotes(prev => prev.map(note =>
                        note.id === selectedNote.id
                            ? { ...note, is_locked: false, password: null }
                            : note
                    ));
                    setError('');
                    document.querySelector('#notePasswordModal .btn-close').click();
                } catch (err) {
                    setError(err.response?.data?.message || 'Error disabling password');
                }
            };

            // Xử lý chỉnh sửa hồ sơ
            const handleProfileEdit = async (e) => {
                e.preventDefault();
                const displayName = e.target.displayName.value;
                const avatar = e.target.avatar.files[0];
                const formData = new FormData();
                formData.append('display_name', displayName);
                if (avatar) formData.append('avatar', avatar);
                try {
                    const response = await axios.post('/user/profile', formData, {
                        headers: { 'Content-Type': 'multipart/form-data' }
                    });
                    setUser(response.data);
                    document.querySelector('#profileModal .btn-close').click();
                } catch (err) {
                    setError(err.response?.data?.message || 'Error updating profile');
                }
            };

            // Xử lý thay đổi mật khẩu tài khoản
            const handleAccountPasswordChange = async (e) => {
                e.preventDefault();
                const currentPassword = e.target.currentPassword.value;
                const newPassword = e.target.newPassword.value;
                const confirmNewPassword = e.target.confirmNewPassword.value;
                if (!newPassword || newPassword !== confirmNewPassword) {
                    setError('New passwords must match and cannot be empty');
                    return;
                }
                try {
                    await axios.post('/user/password', {
                        current_password: currentPassword,
                        password: newPassword,
                        password_confirmation: confirmNewPassword
                    });
                    setError('');
                    document.querySelector('#changePasswordModal .btn-close').click();
                } catch (err) {
                    setError(err.response?.data?.message || 'Error changing password');
                }
            };

            // Xử lý quản lý nhãn
            const handleAddLabel = async (e) => {
                e.preventDefault();
                const newLabel = e.target.newLabel.value.trim();
                if (!newLabel) {
                    setError('Label name is required');
                    return;
                }
                if (labels.includes(newLabel)) {
                    setError('Label already exists');
                    return;
                }
                try {
                    if (!isOffline) {
                        const response = await axios.post('/labels', { name: newLabel });
                        setLabels(prev => [...prev, response.data.name]);
                        await saveToDB('labels', [...labels, response.data.name]);
                    } else {
                        setLabels(prev => [...prev, newLabel]);
                        await saveToDB('pendingSync', { id: Date.now(), action: 'create-label', data: { name: newLabel } });
                    }
                    setError('');
                    e.target.newLabel.value = '';
                } catch (err) {
                    setError(err.response?.data?.message || 'Error adding label');
                }
            };

            const handleEditLabel = async (oldLabel, newLabel) => {
                if (!newLabel) {
                    setError('New label name is required');
                    return;
                }
                if (labels.includes(newLabel)) {
                    setError('Label already exists');
                    return;
                }
                try {
                    if (!isOffline) {
                        await axios.put(`/labels/${oldLabel}`, { name: newLabel });
                        setLabels(prev => prev.map(label => label === oldLabel ? newLabel : label));
                        setNotes(prev => prev.map(note => ({
                            ...note,
                            labels: note.labels.map(label => label === oldLabel ? newLabel : label)
                        })));
                        await saveToDB('labels', labels.map(label => label === oldLabel ? newLabel : label));
                    } else {
                        setLabels(prev => prev.map(label => label === oldLabel ? newLabel : label));
                        setNotes(prev => prev.map(note => ({
                            ...note,
                            labels: note.labels.map(label => label === oldLabel ? newLabel : label)
                        })));
                        await saveToDB('pendingSync', { id: Date.now(), action: 'update-label', data: { oldName: oldLabel, newName: newLabel } });
                    }
                    setError('');
                } catch (err) {
                    setError(err.response?.data?.message || 'Error editing label');
                }
            };

            const handleDeleteLabel = async (label) => {
                try {
                    if (!isOffline) {
                        await axios.delete(`/labels/${label}`);
                        setLabels(prev => prev.filter(l => l !== label));
                        setNotes(prev => prev.map(note => ({
                            ...note,
                            labels: note.labels.filter(l => l !== label)
                        })));
                        await saveToDB('labels', labels.filter(l => l !== label));
                    } else {
                        setLabels(prev => prev.filter(l => l !== label));
                        setNotes(prev => prev.map(note => ({
                            ...note,
                            labels: note.labels.filter(l => l !== label)
                        })));
                        await saveToDB('pendingSync', { id: Date.now(), action: 'delete-label', data: { name: label } });
                    }
                    setError('');
                } catch (err) {
                    setError(err.response?.data?.message || 'Error deleting label');
                }
            };

            // Lọc và sắp xếp ghi chú
            const filteredNotes = notes.filter(note =>
                (note.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                 note.content.toLowerCase().includes(searchQuery.toLowerCase())) &&
                (selectedLabels.length === 0 || note.labels.some(label => selectedLabels.includes(label)))
            ).sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                if (a.pinned && b.pinned) return new Date(b.pinned_at) - new Date(a.pinned_at);
                return new Date(b.created_at) - new Date(a.created_at);
            });

            if (!isLoggedIn) {
                return <LoginScreen setIsLoggedIn={setIsLoggedIn} setUser={setUser} />;
            }

            return (
                <div className={`min-vh-100 ${theme === 'dark' ? 'dark-theme' : ''}`}>
                    {/* Offline Notification */}
                    {isOffline && (
                        <div className="container mt-3">
                            <div className="alert alert-warning alert-dismissible fade show" role="alert">
                                You are offline. Changes will sync when online.
                                <button type="button" className="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        </div>
                    )}

                    {/* Unverified Account Notification */}
                    {!isVerified && (
                        <div className="container mt-3">
                            <div className="alert unverified-alert alert-dismissible fade show" role="alert">
                                Your account is unverified. Please check your email to activate your account.
                                <button className="btn btn-sm btn-primary ms-2" onClick={async () => {
                                    try {
                                        await axios.post('/email/verification-notification');
                                        setError('Verification email sent');
                                    } catch (err) {
                                        setError(err.response?.data?.message || 'Error sending verification email');
                                    }
                                }}>Resend Verification</button>
                                <button type="button" className="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        </div>
                    )}

                    {/* Header */}
                    <nav className="navbar navbar-expand-lg navbar-light bg-white mb-4">
                        <div className="container">
                            <a className="navbar-brand fw-bold" href="#">Notes</a>
                            <button className="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                                <span className="navbar-toggler-icon"></span>
                            </button>
                            <div className="collapse navbar-collapse" id="navbarNav">
                                <ul className="navbar-nav me-auto">
                                    <li className="nav-item">
                                        <a className="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#noteModal" onClick={() => {
                                            setSelectedNote(null);
                                            setNoteForm({ title: '', content: '', labels: [], pinned: false, isLocked: false, password: '', confirmPassword: '', images: [] });
                                        }}>New Note</a>
                                    </li>
                                    <li className="nav-item">
                                        <a className="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#userPreferencesModal">Settings</a>
                                    </li>
                                    <li className="nav-item">
                                        <a className="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#profileModal">Profile</a>
                                    </li>
                                    <li className="nav-item">
                                        <a className="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal">Change Password</a>
                                    </li>
                                    <li className="nav-item">
                                        <a className="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#labelManagementModal">Labels</a>
                                    </li>
                                    <li className="nav-item">
                                        <a className="nav-link" href="#shared-notes">Shared Notes</a>
                                    </li>
                                </ul>
                                <div className="d-flex align-items-center gap-2">
                                    <input
                                        type="text"
                                        className="form-control"
                                        placeholder="Search notes..."
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        style={{ maxWidth: '200px' }}
                                        aria-label="Search notes"
                                    />
                                    <button
                                        className={`btn btn-outline-secondary ${viewMode === 'grid' ? 'active' : ''}`}
                                        onClick={() => setViewMode('grid')}
                                        title="Grid View"
                                        aria-label="Grid View"
                                    >
                                        <i className="bi bi-grid"></i>
                                    </button>
                                    <button
                                        className={`btn btn-outline-secondary ${viewMode === 'list' ? 'active' : ''}`}
                                        onClick={() => setViewMode('list')}
                                        title="List View"
                                        aria-label="List View"
                                    >
                                        <i className="bi bi-list"></i>
                                    </button>
                                    <button
                                        className="btn btn-outline-secondary"
                                        onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')}
                                        title={theme === 'light' ? 'Dark Theme' : 'Light Theme'}
                                        aria-label={theme === 'light' ? 'Dark Theme' : 'Light Theme'}
                                    >
                                        <i className={theme === 'light' ? 'bi bi-moon' : 'bi bi-sun'}></i>
                                    </button>
                                    <button className="btn btn-outline-danger" onClick={() => {
                                        localStorage.removeItem('token');
                                        setIsLoggedIn(false);
                                    }} aria-label="Sign Out">
                                        Sign Out
                                    </button>
                                </div>
                            </div>
                        </div>
                    </nav>

                    {/* Label Filters */}
                    <div className="container mb-4">
                        <div className="d-flex flex-wrap gap-3">
                            {labels.map(label => (
                                <div className="form-check" key={label}>
                                    <input
                                        className="form-check-input"
                                        type="checkbox"
                                        id={label}
                                        checked={selectedLabels.includes(label)}
                                        onChange={() => {
                                            setSelectedLabels(prev =>
                                                prev.includes(label) ? prev.filter(l => l !== label) : [...prev, label]
                                            );
                                        }}
                                        aria-label={`Filter by ${label}`}
                                    />
                                    <label className="form-check-label" htmlFor={label}>{label}</label>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Notes Display */}
                    <div className="container">
                        <h5 className="mb-3 fw-semibold">My Notes</h5>
                        <div className={`row ${viewMode === 'list' ? 'list-view' : ''}`}>
                            {filteredNotes.map((note, index) => (
                                <div key={note.id} className={viewMode === 'grid' ? 'col-lg-4 col-md-6 mb-4' : 'col-12 mb-3'} style={{ animationDelay: `${index * 0.1}s` }}>
                                    <div className={`card note-card ${userPreferences.noteColor}`}>
                                        <div className="card-header d-flex justify-content-between align-items-center">
                                            <h6 className={`card-title mb-0 ${userPreferences.fontSize}`}>{note.title}</h6>
                                            <div className="d-flex align-items-center">
                                                {note.pinned && <span className="note-icon badge bg-warning text-dark">Pinned</span>}
                                                {note.is_locked && <span className="note-icon badge bg-danger">Locked</span>}
                                                {note.shared && (
                                                    <span className="note-icon badge bg-info">
                                                        Shared ({note.shared_with.map(s => s.permission).join(', ')})
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                        <div className="card-body">
                                            <p className={`card-text ${userPreferences.fontSize}`} style={{ maxHeight: '80px', overflow: 'hidden', marginBottom: '1rem' }}>
                                                {note.content}
                                            </p>
                                            {note.images.length > 0 && (
                                                <div className="mb-2">
                                                    {note.images.map((img, i) => (
                                                        <img key={i} src={img} alt={`Attachment ${i + 1}`} className="image-preview" />
                                                    ))}
                                                </div>
                                            )}
                                            {note.labels.length > 0 && (
                                                <div className="mb-2">
                                                    {note.labels.map(label => (
                                                        <span key={label} className="badge bg-secondary me-1">{label}</span>
                                                    ))}
                                                </div>
                                            )}
                                            <div className="d-flex gap-2 flex-wrap">
                                                <button
                                                    className="btn btn-outline-primary btn-sm"
                                                    data-bs-toggle="modal"
                                                    data-bs-target={note.is_locked ? '#passwordVerificationModal' : '#viewNoteModal'}
                                                    data-bs-target-modal="#viewNoteModal"
                                                    onClick={() => {
                                                        setSelectedNote(note);
                                                        setError('');
                                                        if (!note.is_locked) {
                                                            document.querySelector('#viewNoteModal').classList.add('show');
                                                            document.querySelector('#viewNoteModal').style.display = 'block';
                                                        }
                                                    }}
                                                    aria-label={`View ${note.title}`}
                                                >
                                                    View
                                                </button>
                                                <button
                                                    className="btn btn-outline-primary btn-sm"
                                                    data-bs-toggle="modal"
                                                    data-bs-target={note.is_locked ? '#passwordVerificationModal' : '#noteModal'}
                                                    data-bs-target-modal="#noteModal"
                                                    onClick={() => {
                                                        setSelectedNote(note);
                                                        if (!note.is_locked) {
                                                            setNoteForm({
                                                                title: note.title,
                                                                content: note.content,
                                                                labels: note.labels,
                                                                pinned: note.pinned,
                                                                isLocked: note.is_locked,
                                                                password: '',
                                                                confirmPassword: '',
                                                                images: note.images
                                                            });
                                                        }
                                                    }}
                                                    aria-label={`Edit ${note.title}`}
                                                >
                                                    Edit
                                                </button>
                                                <button
                                                    className="btn btn-outline-info btn-sm"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#shareNoteModal"
                                                    onClick={() => setSelectedNote(note)}
                                                    aria-label={`Share ${note.title}`}
                                                >
                                                    Share
                                                </button>
                                                <button
                                                    className="btn btn-outline-secondary btn-sm"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#notePasswordModal"
                                                    onClick={() => setSelectedNote(note)}
                                                    aria-label={`Manage Password for ${note.title}`}
                                                >
                                                    Manage Password
                                                </button>
                                                <button
                                                    className="btn btn-outline-danger btn-sm"
                                                    data-bs-toggle="modal"
                                                    data-bs-target={note.is_locked ? '#passwordVerificationModal' : '#confirmDeleteModal'}
                                                    data-bs-target-modal="#confirmDeleteModal"
                                                    onClick={() => setSelectedNote(note)}
                                                    aria-label={`Delete ${note.title}`}
                                                >
                                                    Delete
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* Shared Notes Section */}
                        <div id="shared-notes" className="mt-5">
                            <h5 className="mb-3 fw-semibold">Notes Shared with Me</h5>
                            {sharedNotes.length > 0 ? (
                                <div className={`row ${viewMode === 'list' ? 'list-view' : ''}`}>
                                    {sharedNotes.map((note, index) => (
                                        <div key={note.id} className={viewMode === 'grid' ? 'col-lg-4 col-md-6 mb-4' : 'col-12 mb-3'} style={{ animationDelay: `${index * 0.1}s` }}>
                                            <div className={`card shared-note-card ${userPreferences.noteColor}`}>
                                                <div className="card-body">
                                                    <h6 className={`card-title mb-2 ${userPreferences.fontSize}`}>{note.title}</h6>
                                                    <p className={`card-text ${userPreferences.fontSize}`} style={{ maxHeight: '60px', overflow: 'hidden', marginBottom: '1rem' }}>
                                                        {note.content}
                                                    </p>
                                                    <div className="shared-note-meta mb-2">
                                                        <div>Shared by: {note.shared_by}</div>
                                                        <div>Shared on: {new Date(note.shared_at).toLocaleString()}</div>
                                                    </div>
                                                    <div className="status-badges mb-3">
                                                        <span className={`badge ${note.permission === 'edit' ? 'bg-success' : 'bg-primary'}`}>
                                                            {note.permission === 'edit' ? 'Editable' : 'Read-Only'}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div className="card-footer d-flex gap-2 flex-wrap">
                                                    <button
                                                        className="btn btn-outline-primary btn-sm"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#viewNoteModal"
                                                        onClick={() => {
                                                            setSelectedNote(note);
                                                            setError('');
                                                        }}
                                                        aria-label={`View ${note.title}`}
                                                    >
                                                        <i className="bi bi-eye me-1"></i> View
                                                    </button>
                                                    {note.permission === 'edit' && (
                                                        <button
                                                            className="btn btn-outline-primary btn-sm"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#noteModal"
                                                            onClick={() => {
                                                                setSelectedNote(note);
                                                                setNoteForm({
                                                                    title: note.title,
                                                                    content: note.content,
                                                                    labels: [],
                                                                    pinned: false,
                                                                    isLocked: false,
                                                                    password: '',
                                                                    confirmPassword: '',
                                                                    images: note.images
                                                                });
                                                            }}
                                                            aria-label={`Edit ${note.title}`}
                                                        >
                                                            <i className="bi bi-pencil me-1"></i> Edit
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <p className="text-muted">No notes have been shared with you.</p>
                            )}
                        </div>
                    </div>

                    {/* Note Create/Edit Modal */}
                    <div className="modal fade" id="noteModal" tabIndex="-1" aria-labelledby="noteModalLabel" aria-hidden="true">
                        <div className="modal-dialog modal-lg">
                            <div className="modal-content">
                                {isSaving && (
                                    <div className="spinner-overlay">
                                        <div className="spinner-border text-primary" role="status">
                                            <span className="visually-hidden">Saving...</span>
                                        </div>
                                    </div>
                                )}
                                <div className="modal-header">
                                    <h5 className="modal-title fw-semibold" id="noteModalLabel">{selectedNote ? 'Edit Note' : 'New Note'}</h5>
                                    <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div className="modal-body">
                                    {error && <div className="alert alert-danger alert-dismissible fade show" role="alert">{error}<button type="button" className="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>}
                                    {collaborationUsers.length > 0 && (
                                        <div className="collaboration-indicator">
                                            <span>Editing with:</span>
                                            {collaborationUsers.map(user => (
                                                <img
                                                    key={user.name}
                                                    src={user.avatar}
                                                    alt={`${user.name}'s avatar`}
                                                    className="collaboration-avatar"
                                                    title={user.name}
                                                />
                                            ))}
                                        </div>
                                    )}
                                    <form noValidate>
                                        <div className="mb-4">
                                            <label htmlFor="noteTitle" className="form-label fw-medium">Title</label>
                                            <input
                                                type="text"
                                                className="form-control"
                                                id="noteTitle"
                                                value={noteForm.title}
                                                onChange={(e) => setNoteForm({ ...noteForm, title: e.target.value })}
                                                required
                                                aria-describedby="noteTitleFeedback"
                                                placeholder="Enter note title"
                                            />
                                            <div id="noteTitleFeedback" className="form-feedback">Title is required</div>
                                        </div>
                                        <div className="mb-4">
                                            <label htmlFor="noteContent" className="form-label fw-medium">Content</label>
                                            <textarea
                                                className="form-control"
                                                id="noteContent"
                                                rows="6"
                                                value={noteForm.content}
                                                onChange={(e) => setNoteForm({ ...noteForm, content: e.target.value })}
                                                required
                                                aria-describedby="noteContentFeedback"
                                                placeholder="Write your note here..."
                                            ></textarea>
                                            <div id="noteContentFeedback" className="form-feedback">Content is required</div>
                                        </div>
                                        <div className="mb-4">
                                            <label className="form-label fw-medium">Attach Images</label>
                                            <input
                                                type="file"
                                                className="form-control"
                                                accept="image/*"
                                                multiple
                                                onChange={async (e) => {
                                                    const files = Array.from(e.target.files);
                                                    const formData = new FormData();
                                                    files.forEach(file => formData.append('images[]', file));
                                                    try {
                                                        const response = await axios.post('/upload-images', formData, {
                                                            headers: { 'Content-Type': 'multipart/form-data' }
                                                        });
                                                        setNoteForm({ ...noteForm, images: [...noteForm.images, ...response.data.urls] });
                                                    } catch (err) {
                                                        setError(err.response?.data?.message || 'Error uploading images');
                                                    }
                                                }}
                                                aria-describedby="imageFeedback"
                                            />
                                            <div id="imageFeedback" className="form-feedback">Select valid image files</div>
                                            {noteForm.images.length > 0 && (
                                                <div className="mt-2 d-flex flex-wrap gap-2">
                                                    {noteForm.images.map((img, i) => (
                                                        <div key={i} className="position-relative">
                                                            <img src={img} alt={`Preview ${i + 1}`} className="image-preview" />
                                                            <button
                                                                type="button"
                                                                className="btn btn-sm btn-danger position-absolute top-0 end-0"
                                                                style={{ transform: 'translate(50%, -50%)' }}
                                                                onClick={() => setNoteForm({ ...noteForm, images: noteForm.images.filter((_, index) => index !== i) })}
                                                                aria-label={`Remove image ${i + 1}`}
                                                            >
                                                                <i className="bi bi-x"></i>
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                        {!selectedNote?.shared_by && (
                                            <>
                                                <div className="mb-4">
                                                    <label className="form-label fw-medium">Labels</label>
                                                    <select
                                                        className="form-select"
                                                        multiple
                                                        value={noteForm.labels}
                                                        onChange={(e) => setNoteForm({ ...noteForm, labels: Array.from(e.target.selectedOptions, option => option.value) })}
                                                        aria-label="Select labels"
                                                    >
                                                        {labels.map(label => (
                                                            <option key={label} value={label}>{label}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                                <div className="form-check mb-4">
                                                    <input
                                                        className="form-check-input"
                                                        type="checkbox"
                                                        id="pinNote"
                                                        checked={noteForm.pinned}
                                                        onChange={(e) => setNoteForm({ ...noteForm, pinned: e.target.checked })}
                                                        aria-label="Pin to top"
                                                    />
                                                    <label className="form-check-label" htmlFor="pinNote">Pin to Top</label>
                                                </div>
                                                <div className="form-check mb-4">
                                                    <input
                                                        className="form-check-input"
                                                        type="checkbox"
                                                        id="lockNote"
                                                        checked={noteForm.isLocked}
                                                        onChange={(e) => {
                                                            setNoteForm({ ...noteForm, isLocked: e.target.checked });
                                                            document.getElementById('passwordFields').style.display = e.target.checked ? 'block' : 'none';
                                                        }}
                                                        aria-label="Password protect"
                                                    />
                                                    <label className="form-check-label" htmlFor="lockNote">Password Protect</label>
                                                </div>
                                                <div id="passwordFields" style={{ display: noteForm.isLocked ? 'block' : 'none' }}>
                                                    <div className="mb-4">
                                                        <label htmlFor="notePassword" className="form-label fw-medium">Password</label>
                                                        <input
                                                            type="password"
                                                            className="form-control"
                                                            id="notePassword"
                                                            value={noteForm.password}
                                                            onChange={(e) => setNoteForm({ ...noteForm, password: e.target.value })}
                                                            aria-describedby="notePasswordFeedback"
                                                            placeholder="Enter password"
                                                        />
                                                        <div id="notePasswordFeedback" className="form-feedback">Password is required</div>
                                                    </div>
                                                    <div className="mb-4">
                                                        <label htmlFor="confirmNotePassword" className="form-label fw-medium">Confirm Password</label>
                                                        <input
                                                            type="password"
                                                            className="form-control"
                                                            id="confirmNotePassword"
                                                            value={noteForm.confirmPassword}
                                                            onChange={(e) => setNoteForm({ ...noteForm, confirmPassword: e.target.value })}
                                                            aria-describedby="confirmNotePasswordFeedback"
                                                            placeholder="Confirm password"
                                                        />
                                                        <div id="confirmNotePasswordFeedback" className="form-feedback">Please confirm your password</div>
                                                    </div>
                                                </div>
                                            </>
                                        )}
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* View Note Modal */}
                    <div className="modal fade" id="viewNoteModal" tabIndex="-1" aria-labelledby="viewNoteModalLabel" aria-hidden="true">
                        <div className="modal-dialog modal-lg">
                            <div className="modal-content">
                                <div className="modal-header">
                                    <h5 className="modal-title fw-semibold" id="viewNoteModalLabel">{selectedNote?.title || 'View Note'}</h5>
                                    <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div className="modal-body">
                                    {error && (
                                        <div className="alert alert-danger alert-dismissible fade show" role="alert">
                                            {error}
                                            <button type="button" className="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                        </div>
                                    )}
                                    {selectedNote && (
                                        <div>
                                            <h6 className={`fw-semibold ${userPreferences.fontSize} mb-3`}>{selectedNote.title}</h6>
                                            <div className={`view-note-content ${userPreferences.fontSize}`}>
                                                {selectedNote.content}
                                            </div>
                                            {selectedNote.images.length > 0 && (
                                                <div className="view-note-images mb-4">
                                                    {selectedNote.images.map((img, i) => (
                                                        <img key={i} src={img} alt={`Attachment ${i + 1}`} className="view-note-image" />
                                                    ))}
                                                </div>
                                            )}
                                            {selectedNote.labels?.length > 0 && (
                                                <div className="mb-4">
                                                    <strong>Labels: </strong>
                                                    {selectedNote.labels.map(label => (
                                                        <span key={label} className="badge bg-secondary me-1">{label}</span>
                                                    ))}
                                                </div>
                                            )}
                                            <div className="status-badges mb-4">
                                                {selectedNote.pinned && <span className="badge bg-warning text-dark">Pinned</span>}
                                                {selectedNote.is_locked && <span className="badge bg-danger">Locked</span>}
                                                {selectedNote.shared && (
                                                    <span className="badge bg-info">
                                                        Shared ({selectedNote.shared_with?.map(s => s.permission).join(', ')})
                                                    </span>
                                                )}
                                                {selectedNote.shared_by && (
                                                    <span className={`badge ${selectedNote.permission === 'edit' ? 'bg-success' : 'bg-primary'}`}>
                                                        {selectedNote.permission === 'edit' ? 'Editable' : 'Read-Only'}
                                                    </span>
                                                )}
                                            </div>
                                            {selectedNote.shared_by && (
                                                <div className="shared-note-meta mb-4">
                                                    <div>Shared by: {selectedNote.shared_by}</div>
                                                    <div>Shared on: {new Date(selectedNote.shared_at).toLocaleString()}</div>
                                                </div>
                                            )}
                                            <div className="d-flex gap-2 flex-wrap">
                                                {!selectedNote.shared_by && (
                                                    <>
                                                        <button
                                                            className="btn btn-outline-primary btn-sm"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#noteModal"
                                                            onClick={() => {
                                                                setNoteForm({
                                                                    title: selectedNote.title,
                                                                    content: selectedNote.content,
                                                                    labels: selectedNote.labels,
                                                                    pinned: selectedNote.pinned,
                                                                    isLocked: selectedNote.is_locked,
                                                                    password: '',
                                                                    confirmPassword: '',
                                                                    images: selectedNote.images
                                                                });
                                                                document.querySelector('#viewNoteModal .btn-close').click();
                                                            }}
                                                            aria-label={`Edit ${selectedNote.title}`}
                                                        >
                                                            <i className="bi bi-pencil me-1"></i> Edit
                                                        </button>
                                                        <button
                                                            className="btn btn-outline-info btn-sm"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#shareNoteModal"
                                                            onClick={() => document.querySelector('#viewNoteModal .btn-close').click()}
                                                            aria-label={`Share ${selectedNote.title}`}
                                                        >
                                                            <i className="bi bi-share me-1"></i> Share
                                                        </button>
                                                        <button
                                                            className="btn btn-outline-secondary btn-sm"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#notePasswordModal"
                                                            onClick={() => document.querySelector('#viewNoteModal .btn-close').click()}
                                                            aria-label={`Manage Password for ${selectedNote.title}`}
                                                        >
                                                            <i className="bi bi-lock me-1"></i> Manage Password
                                                        </button>
                                                        <button
                                                            className="btn btn-outline-danger btn-sm"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#confirmDeleteModal"
                                                            onClick={() => document.querySelector('#viewNoteModal .btn-close').click()}
                                                            aria-label={`Delete ${selectedNote.title}`}
                                                        >
                                                            <i className="bi bi-trash me-1"></i> Delete
                                                        </button>
                                                    </>
                                                )}
                                                {selectedNote.shared_by && selectedNote.permission === 'edit' && (
                                                    <button
                                                        className="btn btn-outline-primary btn-sm"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#noteModal"
                                                        onClick={() => {
                                                            setNoteForm({
                                                                title: selectedNote.title,
                                                                content: selectedNote.content,
                                                                labels: [],
                                                                pinned: false,
                                                                isLocked: false,
                                                                password: '',
                                                                confirmPassword: '',
                                                                images: selectedNote.images
                                                            });
                                                            document.querySelector('#viewNoteModal .btn-close').click();
                                                        }}
                                                        aria-label={`Edit ${selectedNote.title}`}
                                                    >
                                                        <i className="bi bi-pencil me-1"></i> Edit
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Password Verification Modal */}
                    <div className="modal fade" id="passwordVerificationModal" tabIndex="-1" aria-labelledby="passwordVerificationModalLabel" aria-hidden="true">
                        <div className="modal-dialog">
                            <div className="modal-content">
                                <div className="modal-header">
                                    <h5 className="modal-title fw-semibold" id="passwordVerificationModalLabel">Enter Note Password</h5>
                                    <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div className="modal-body">
                                    {error && (
                                        <div className="alert alert-danger alert-dismissible fade show" role="alert">
                                            {error}
                                            <button type="button" className="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                        </div>
                                    )}
                                    <form onSubmit={handlePasswordVerification}>
                                        <div className="mb-3">
                                            <label htmlFor="passwordInput" className="form-label fw-medium">Password</label>
                                            <input
                                                type="password"
                                                className="form-control"
                                                id="passwordInput"
                                                value={passwordInput}
                                                onChange={(e) => setPasswordInput(e.target.value)}
                                                required
                                                aria-describedby="passwordInputFeedback"
                                            />
                                            <div id="passwordInputFeedback" className="form-feedback">Password is required</div>
                                        </div>
                                        <button type="submit" className="btn btn-primary fw-medium">Verify</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Note Password Management Modal */}
                    <div className="modal fade" id="notePasswordModal" tabIndex="-1" aria-labelledby="notePasswordModalLabel" aria-hidden="true">
                        <div className="modal-dialog">
                            <div className="modal-content">
                                <div className="modal-header">
                                    <h5 className="modal-title fw-semibold" id="notePasswordModalLabel">Manage Note Password</h5>
                                    <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div className="modal-body">
                                    {error && <div className="alert alert-danger alert-dismissible fade show" role="alert">{error}<button type="button" className="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>}
                                    {selectedNote?.is_locked ? (
                                        <>
                                            <form onSubmit={handleNotePasswordChange} className="mb-3">
                                                <div className="mb-3">
                                                    <label htmlFor="currentPassword" className="form-label fw-medium">Current Password</label>
                                                    <input
                                                        type="password"
                                                        className="form-control"
                                                        id="currentPassword"
                                                        required
                                                        aria-describedby="currentPasswordFeedback"
                                                    />
                                                    <div id="currentPasswordFeedback" className="form-feedback">Current password is required</div>
                                                </div>
                                                <div className="mb-3">
                                                    <label htmlFor="newPassword" className="form-label fw-medium">New Password</label>
                                                    <input
                                                        type="password"
                                                        className="form-control"
                                                        id="newPassword"
                                                        required
                                                        aria-describedby="newPasswordFeedback"
                                                    />
                                                    <div id="newPasswordFeedback" className="form-feedback">New password is required</div>
                                                </div>
                                                <div className="mb-3">
                                                    <label htmlFor="confirmNewPassword" className="form-label fw-medium">Confirm New Password</label>
                                                    <input
                                                        type="password"
                                                        className="form-control"
                                                        id="confirmNewPassword"
                                                        required
                                                        aria-describedby="confirmNewPasswordFeedback"
                                                    />
                                                    <div id="confirmNewPasswordFeedback" className="form-feedback">Please confirm your password</div>
                                                </div>
                                                <button type="submit" className="btn btn-primary fw-medium">Change Password</button>
                                            </form>
                                            <form onSubmit={handleNotePasswordDisable}>
                                                <div className="mb-3">
                                                    <label htmlFor="currentPasswordDisable" className="form-label fw-medium">Current Password</label>
                                                    <input
                                                        type="password"
                                                        className="form-control"
                                                        id="currentPasswordDisable"
                                                        required
                                                        aria-describedby="currentPasswordDisableFeedback"
                                                    />
                                                    <div id="currentPasswordDisableFeedback" className="form-feedback">Current password is required</div>
                                                </div>
                                                <button type="submit" className="btn btn-danger fw-medium">Disable Password</button>
                                            </form>
                                        </>
                                    ) : (
                                        <p className="text-muted">This note is not password-protected. Enable protection in the edit modal.</p>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Share Note Modal */}
                    <div className="modal fade" id="shareNoteModal" tabIndex="-1" aria-labelledby="shareNoteModalLabel" aria-hidden="true">
                        <div className="modal-dialog">
                            <div className="modal-content">
                                <div className="modal-header">
                                    <h5 className="modal-title fw-semibold" id="shareNoteModalLabel">
                                        Share "{selectedNote?.title || 'Note'}"
                                    </h5>
                                    <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div className="modal-body">
                                    {error && <div className="alert alert-danger alert-dismissible fade show" role="alert">{error}<button type="button" className="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>}
                                    <form onSubmit={handleShare} noValidate>
                                        <div className="mb-3">
                                            <label htmlFor="recipientEmails" className="form-label fw-medium">Recipient Emails</label>
                                            <input
                                                type="text"
                                                className="form-control"
                                                id="recipientEmails"
                                                placeholder="Enter emails (comma-separated)"
                                                required
                                                aria-describedby="recipientEmailsFeedback"
                                            />
                                            <div id="recipientEmailsFeedback" className="form-feedback">Enter valid email addresses</div>
                                        </div>
                                        <div className="mb-3">
                                            <label className="form-label fw-medium">Permission</label>
                                            <select className="form-select" aria-label="Select permission">
                                                <option value="read">Read-Only</option>
                                                <option value="edit">Editable</option>
                                            </select>
                                        </div>
                                        <button type="submit" className="btn btn-primary fw-medium">Share</button>
                                    </form>
                                    {selectedNote?.shared_with?.length > 0 && (
                                        <div className="mt-4">
                                            <h6 className="fw-semibold">Shared With</h6>
                                            <ul className="list-group">
                                                {selectedNote.shared_with.map((share, index) => (
                                                    <li key={index} className="list-group-item d-flex justify-content-between align-items-center">
                                                        {share.email} ({share.permission})
                                                        <button className="btn btn-outline-danger btn-sm" onClick={async () => {
                                                            try {
                                                                await axios.delete(`/notes/${selectedNote.id}/share`, { data: { email: share.email } });
                                                                setNotes(prev => prev.map(note =>
                                                                    note.id === selectedNote.id
                                                                        ? { ...note, shared_with: note.shared_with.filter(s => s.email !== share.email) }
                                                                        : note
                                                                ));
                                                            } catch (err) {
                                                                setError(err.response?.data?.message || 'Error revoking share');
                                                            }
                                                        }}>Revoke```javascript
                                                        </button>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Confirm Delete Modal */}
                    <div className="modal fade" id="confirmDeleteModal" tabIndex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
                        <div className="modal-dialog">
                            <div className="modal-content">
                                <div className="modal-header">
                                    <h5 className="modal-title fw-semibold" id="confirmDeleteModalLabel">Confirm Delete</h5>
                                    <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div className="modal-body">
                                    {error && (
                                        <div className="alert alert-danger alert-dismissible fade show" role="alert">
                                            {error}
                                            <button type="button" className="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                        </div>
                                    )}
                                    <p>Are you sure you want to delete the note "<strong>{selectedNote?.title}</strong>"? This action cannot be undone.</p>
                                </div>
                                <div className="modal-footer">
                                    <button type="button" className="btn btn-secondary fw-medium" data-bs-dismiss="modal">Cancel</button>
                                    <button
                                        type="button"
                                        className="btn btn-danger fw-medium"
                                        onClick={async () => {
                                            try {
                                                if (!isOffline) {
                                                    await axios.delete(`/notes/${selectedNote.id}`);
                                                    setNotes(prev => prev.filter(note => note.id !== selectedNote.id));
                                                } else {
                                                    await saveToDB('pendingSync', { id: selectedNote.id, action: 'delete', data: {} });
                                                    setNotes(prev => prev.filter(note => note.id !== selectedNote.id));
                                                }
                                                setError('');
                                                document.querySelector('#confirmDeleteModal .btn-close').click();
                                            } catch (err) {
                                                setError(err.response?.data?.message || 'Error deleting note');
                                            }
                                        }}
                                        aria-label={`Confirm delete ${selectedNote?.title}`}
                                    >
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Profile Modal */}
                    <div className="modal fade" id="profileModal" tabIndex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
                        <div className="modal-dialog">
                            <div className="modal-content">
                                <div className="modal-header">
                                    <h5 className="modal-title fw-semibold" id="profileModalLabel">Edit Profile</h5>
                                    <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div className="modal-body">
                                    {error && (
                                        <div className="alert alert-danger alert-dismissible fade show" role="alert">
                                            {error}
                                            <button type="button" className="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                        </div>
                                    )}
                                    <form onSubmit={handleProfileEdit} noValidate>
                                        <div className="mb-3">
                                            <label htmlFor="displayName" className="form-label fw-medium">Display Name</label>
                                            <input
                                                type="text"
                                                className="form-control"
                                                id="displayName"
                                                defaultValue={user.displayName}
                                                required
                                                aria-describedby="displayNameFeedback"
                                            />
                                            <div id="displayNameFeedback" className="form-feedback">Display name is required</div>
                                        </div>
                                        <div className="mb-3">
                                            <label htmlFor="avatar" className="form-label fw-medium">Profile Picture</label>
                                            <input
                                                type="file"
                                                className="form-control"
                                                id="avatar"
                                                accept="image/*"
                                                aria-describedby="avatarFeedback"
                                            />
                                            <div id="avatarFeedback" className="form-feedback">Select a valid image file</div>
                                            {user.avatar && (
                                                <img
                                                    src={user.avatar}
                                                    alt="Current profile picture"
                                                    className="img-thumbnail mt-2"
                                                    style={{ maxWidth: '100px' }}
                                                />
                                            )}
                                        </div>
                                        <button type="submit" className="btn btn-primary fw-medium">Save Changes</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* User Preferences Modal */}
                    <div className="modal fade" id="userPreferencesModal" tabIndex="-1" aria-labelledby="userPreferencesModalLabel" aria-hidden="true">
                        <div className="modal-dialog">
                            <div className="modal-content">
                                <div className="modal-header">
                                    <h5 className="modal-title fw-semibold" id="userPreferencesModalLabel">Preferences</h5>
                                    <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div className="modal-body">
                                    {error && (
                                        <div className="alert alert-danger alert-dismissible fade show" role="alert">
                                            {error}
                                            <button type="button" className="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                        </div>
                                    )}
                                    <form onSubmit={(e) => {
                                        e.preventDefault();
                                        setUserPreferences({
                                            fontSize: e.target.fontSize.value,
                                            noteColor: e.target.noteColor.value,
                                            theme: e.target.theme.value
                                        });
                                        setTheme(e.target.theme.value);
                                        document.querySelector('#userPreferencesModal .btn-close').click();
                                    }} noValidate>
                                        <div className="mb-3">
                                            <label htmlFor="fontSize" className="form-label fw-medium">Font Size</label>
                                            <select
                                                className="form-select"
                                                id="fontSize"
                                                defaultValue={userPreferences.fontSize}
                                                aria-label="Select font size"
                                            >
                                                <option value="fs-6">Small</option>
                                                <option value="fs-5">Medium</option>
                                                <option value="fs-4">Large</option>
                                            </select>
                                        </div>
                                        <div className="mb-3">
                                            <label htmlFor="noteColor" className="form-label fw-medium">Note Background Color</label>
                                            <select
                                                className="form-select"
                                                id="noteColor"
                                                defaultValue={userPreferences.noteColor}
                                                aria-label="Select note color"
                                            >
                                                <option value="bg-white">White</option>
                                                <option value="bg-light">Light Gray</option>
                                                <option value="bg-warning-subtle">Yellow</option>
                                            </select>
                                        </div>
                                        <div className="mb-3">
                                            <label htmlFor="theme" className="form-label fw-medium">Theme</label>
                                            <select
                                                className="form-select"
                                                id="theme"
                                                defaultValue={userPreferences.theme}
                                                aria-label="Select theme"
                                            >
                                                <option value="light">Light</option>
                                                <option value="dark">Dark</option>
                                            </select>
                                        </div>
                                        <button type="submit" className="btn btn-primary fw-medium">Save Preferences</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Change Password Modal */}
                    <div className="modal fade" id="changePasswordModal" tabIndex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
                        <div className="modal-dialog">
                            <div className="modal-content">
                                <div className="modal-header">
                                    <h5 className="modal-title fw-semibold" id="changePasswordModalLabel">Change Password</h5>
                                    <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div className="modal-body">
                                    {error && (
                                        <div className="alert alert-danger alert-dismissible fade show" role="alert">
                                            {error}
                                            <button type="button" className="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                        </div>
                                    )}
                                    <form onSubmit={handleAccountPasswordChange} noValidate>
                                        <div className="mb-3">
                                            <label htmlFor="currentPassword" className="form-label fw-medium">Current Password</label>
                                            <input
                                                type="password"
                                                className="form-control"
                                                id="currentPassword"
                                                required
                                                aria-describedby="currentPasswordFeedback"
                                            />
                                            <div id="currentPasswordFeedback" className="form-feedback">Current password is required</div>
                                        </div>
                                        <div className="mb-3">
                                            <label htmlFor="newPassword" className="form-label fw-medium">New Password</label>
                                            <input
                                                type="password"
                                                className="form-control"
                                                id="newPassword"
                                                required
                                                aria-describedby="newPasswordFeedback"
                                            />
                                            <div id="newPasswordFeedback" className="form-feedback">New password is required</div>
                                        </div>
                                        <div className="mb-3">
                                            <label htmlFor="confirmNewPassword" className="form-label fw-medium">Confirm New Password</label>
                                            <input
                                                type="password"
                                                className="form-control"
                                                id="confirmNewPassword"
                                                required
                                                aria-describedby="confirmNewPasswordFeedback"
                                            />
                                            <div id="confirmNewPasswordFeedback" className="form-feedback">Please confirm your password</div>
                                        </div>
                                        <button type="submit" className="btn btn-primary fw-medium">Change Password</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Label Management Modal */}
                    <div className="modal fade" id="labelManagementModal" tabIndex="-1" aria-labelledby="labelManagementModalLabel" aria-hidden="true">
                        <div className="modal-dialog">
                            <div className="modal-content">
                                <div className="modal-header">
                                    <h5 className="modal-title fw-semibold" id="labelManagementModalLabel">Manage Labels</h5>
                                    <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div className="modal-body">
                                    {error && (
                                        <div className="alert alert-danger alert-dismissible fade show" role="alert">
                                            {error}
                                            <button type="button" className="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                        </div>
                                    )}
                                    <form onSubmit={handleAddLabel} className="mb-4" noValidate>
                                        <div className="input-group">
                                            <input
                                                type="text"
                                                className="form-control"
                                                id="newLabel"
                                                placeholder="Enter new label"
                                                required
                                                aria-describedby="newLabelFeedback"
                                            />
                                            <button type="submit" className="btn btn-primary fw-medium">Add</button>
                                        </div>
                                        <div id="newLabelFeedback" className="form-feedback">Label name is required</div>
                                    </form>
                                    <ul className="list-group">
                                        {labels.map(label => (
                                            <li key={label} className="list-group-item d-flex justify-content-between align-items-center">
                                                <input
                                                    type="text"
                                                    className="form-control"
                                                    defaultValue={label}
                                                    onBlur={(e) => handleEditLabel(label, e.target.value.trim())}
                                                    aria-label={`Edit label ${label}`}
                                                />
                                                <button
                                                    className="btn btn-outline-danger btn-sm"
                                                    onClick={() => handleDeleteLabel(label)}
                                                    aria-label={`Delete label ${label}`}
                                                >
                                                    <i className="bi bi-trash"></i>
                                                </button>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Render App component
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>